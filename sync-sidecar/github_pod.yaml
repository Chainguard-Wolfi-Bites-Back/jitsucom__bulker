apiVersion: v1
kind: ConfigMap
metadata:
  name: github-source-config
  namespace: default
data:
  catalog: "{\n    \"streams\": [ \n        { \n            \"sync_mode\": \"full_refresh\",\n            \"destination_sync_mode\": \"overwrite\",\n            \"cursor_field\": [ \n                \"created_at\"\n ],\n            \"stream\": { \n                \"name\": \"commits\",\n                \"json_schema\": { \n                    \"properties\": { \n                        \"author\": { \n                            \"type\": [ \n                                \"null\",\n                                \"object\"\n ],\n                            \"properties\": { \n                                \"avatar_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"events_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"followers_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"following_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"gists_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"gravatar_id\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"html_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"id\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"integer\"\n ]\n },\n                                \"login\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"node_id\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"organizations_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"received_events_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"repos_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"site_admin\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"boolean\"\n ]\n },\n                                \"starred_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"subscriptions_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"type\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n }\n }\n },\n                        \"comments_url\": { \n                            \"type\": [ \n                                \"null\",\n                                \"string\"\n ]\n },\n                        \"commit\": { \n                            \"type\": [ \n                                \"null\",\n                                \"object\"\n ],\n                            \"properties\": { \n                                \"author\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"object\"\n ],\n                                    \"properties\": { \n                                        \"date\": { \n                                            \"type\": [ \n                                                \"null\",\n                                                \"string\"\n ],\n                                            \"format\": \"date-time\"\n },\n                                        \"email\": { \n                                            \"type\": [ \n                                                \"null\",\n                                                \"string\"\n ]\n },\n                                        \"name\": { \n                                            \"type\": [ \n                                                \"null\",\n                                                \"string\"\n ]\n }\n }\n },\n                                \"comment_count\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"integer\"\n ]\n },\n                                \"committer\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"object\"\n ],\n                                    \"properties\": { \n                                        \"date\": { \n                                            \"type\": [ \n                                                \"null\",\n                                                \"string\"\n ],\n                                            \"format\": \"date-time\"\n },\n                                        \"email\": { \n                                            \"type\": [ \n                                                \"null\",\n                                                \"string\"\n ]\n },\n                                        \"name\": { \n                                            \"type\": [ \n                                                \"null\",\n                                                \"string\"\n ]\n }\n }\n },\n                                \"message\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"tree\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"object\"\n ],\n                                    \"properties\": { \n                                        \"sha\": { \n                                            \"type\": [ \n                                                \"null\",\n                                                \"string\"\n ]\n },\n                                        \"url\": { \n                                            \"type\": [ \n                                                \"null\",\n                                                \"string\"\n ]\n }\n }\n },\n                                \"url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"verification\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"object\"\n ],\n                                    \"properties\": { \n                                        \"payload\": { \n                                            \"type\": [ \n                                                \"null\",\n                                                \"string\"\n ]\n },\n                                        \"reason\": { \n                                            \"type\": [ \n                                                \"null\",\n                                                \"string\"\n ]\n },\n                                        \"signature\": { \n                                            \"type\": [ \n                                                \"null\",\n                                                \"string\"\n ]\n },\n                                        \"verified\": { \n                                            \"type\": [ \n                                                \"null\",\n                                                \"boolean\"\n ]\n }\n }\n }\n }\n },\n                        \"committer\": { \n                            \"type\": [ \n                                \"null\",\n                                \"object\"\n ],\n                            \"properties\": { \n                                \"avatar_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"events_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"followers_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"following_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"gists_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"gravatar_id\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"html_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"id\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"integer\"\n ]\n },\n                                \"login\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"node_id\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"organizations_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"received_events_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"repos_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"site_admin\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"boolean\"\n ]\n },\n                                \"starred_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"subscriptions_url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"type\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n },\n                                \"url\": { \n                                    \"type\": [ \n                                        \"null\",\n                                        \"string\"\n ]\n }\n }\n },\n                        \"created_at\": { \n                            \"type\": [ \n                                \"null\",\n                                \"string\"\n ],\n                            \"format\": \"date-time\"\n },\n                        \"html_url\": { \n                            \"type\": [ \n                                \"null\",\n                                \"string\"\n ]\n },\n                        \"node_id\": { \n                            \"type\": [ \n                                \"null\",\n                                \"string\"\n ]\n },\n                        \"parents\": { \n                            \"type\": [ \n                                \"null\",\n                                \"array\"\n ]\n },\n                        \"repository\": { \n                            \"type\": [ \n                                \"string\"\n ]\n },\n                        \"sha\": { \n                            \"type\": [ \n                                \"null\",\n                                \"string\"\n ]\n },\n                        \"url\": { \n                            \"type\": [ \n                                \"null\",\n                                \"string\"\n ]\n }\n }\n },\n                \"supported_sync_modes\": [ \n                    \"full_refresh\",\n                    \"incremental\"\n ],\n                \"source_defined_primary_key\": [ \n                    [ \n                        \"sha\"\n ]\n ],\n                \"source_defined_cursor\": true,\n                \"default_cursor_field\": [ \n                    \"created_at\"\n ]\n }\n }\n ]\n}"
  config: "{\"branch\":\"\",\"client_id\":\"ccf6ad9bdb05b38441a3\",\"client_secret\":\"d34b01ac1d1cc52ce6b9552ea9a20f4b5fe80113\",\"credentials\":{\"access_token\":\"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\",\"option_title\":\"OAuth Credentials\"},\"page_size_for_large_streams\":10,\"repository\":\"jitsucom/jitsu\",\"start_date\":\"2022-04-30T20:00:00Z\"}"

---
apiVersion: v1
kind: Pod
metadata:
  name: github-source
  namespace: default
  labels:
    app: github_source
  #  version: {{ ansible_date_time.iso8601_basic_short }}
spec:
  restartPolicy: Never
  volumes:
    - name: config
      configMap:
        name: github-source-config
        items:
          - key: config
            path: config.json
          - key: catalog
            path: catalog.json
    - name: pipes
      emptyDir: {}
  containers:
    - name: sidecar
      image: docker.io/jitsucom/sidecar:0.0.7
      env:
        - name: SOURCE_ID
          value: github
        - name: TASK_ID
          value: "1"
        - name: BULKER_URL
          value: http://host.docker.internal:3042
        - name: BULKER_AUTH_TOKEN
          value: 21a2ae36-32994870a9fbf2f61ea6f6c8
        - name: CONNECTION_ID
          value: clfsezba10007ccitcu9x2axk
        - name: TASKS_CONNECTION_ID
          value: tasks
        - name: STATE_CONNECTION_ID
          value: tasks_state
        - name: STDOUT_PIPE_FILE
          value: /pipes/stdout
        - name: STDERR_PIPE_FILE
          value: /pipes/stderr
      volumeMounts:
        - name: pipes
          mountPath: /pipes
    - name: github
      image: airbyte/source-github:0.4.3
      command: ['sh', '-c', 'eval "$AIRBYTE_ENTRYPOINT read --config /config/config.json --catalog /config/catalog.json" 2> /pipes/stderr > /pipes/stdout' ]
      volumeMounts:
        - name: config
          mountPath: /config
        - name: pipes
          mountPath: /pipes
  initContainers:
    - name: init
      image: busybox:1.36.0
      command: ["sh", "-c", "mkfifo /pipes/stdout; mkfifo /pipes/stderr"]
      volumeMounts:
        - name: pipes
          mountPath: /pipes

